# ============================================
# CITYMATE - Docker Compose Configuration
# ============================================

services:
  
  # ============================================
  # BASE DE DONNÉES : USER DB
  # ============================================
  user-db:
    image: postgres:15-alpine
    container_name: citymate-user-db
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: ${USER_DB_USER:-citymate_user}
      POSTGRES_PASSWORD: ${USER_DB_PASSWORD:-user_password}
    ports:
      - "5432:5432"
    volumes:
      - user-db-data:/var/lib/postgresql/data
      - ./postgres/init-user-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - citymate-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USER_DB_USER:-citymate_user} -d user_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # BASE DE DONNÉES : CITY DB (avec PostGIS)
  # ============================================
  city-db:
    image: postgis/postgis:15-3.3-alpine
    container_name: citymate-city-db
    environment:
      POSTGRES_DB: city_db
      POSTGRES_USER: ${CITY_DB_USER:-citymate_city}
      POSTGRES_PASSWORD: ${CITY_DB_PASSWORD:-city_password}
    ports:
      - "5433:5432"
    volumes:
      - city-db-data:/var/lib/postgresql/data
      - ./postgres/init-city-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - citymate-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${CITY_DB_USER:-citymate_city} -d city_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # BASE DE DONNÉES : COMMUNITY DB
  # ============================================
  community-db:
    image: postgres:15-alpine
    container_name: citymate-community-db
    environment:
      POSTGRES_DB: community_db
      POSTGRES_USER: ${COMMUNITY_DB_USER:-citymate_community}
      POSTGRES_PASSWORD: ${COMMUNITY_DB_PASSWORD:-community_password}
    ports:
      - "5434:5432"
    volumes:
      - community-db-data:/var/lib/postgresql/data
      - ./postgres/init-community-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - citymate-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${COMMUNITY_DB_USER:-citymate_community} -d community_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # REDIS (pour Rate Limiting)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: citymate-redis
    ports:
      - "6379:6379"
    networks:
      - citymate-network
    restart: unless-stopped

  # ============================================
  # API : USER API (Port 8081)
  # ============================================
  user-api:
    build:
      context: ../user-api
      dockerfile: Dockerfile
    container_name: citymate-user-api
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://user-db:5432/user_db
      SPRING_DATASOURCE_USERNAME: ${USER_DB_USER:-citymate_user}
      SPRING_DATASOURCE_PASSWORD: ${USER_DB_PASSWORD:-user_password}
      JWT_SECRET: ${JWT_SECRET:-Cm2K9#xP7!vQ2@wR4$eT6^yU8&iO0*aS1-dF3+gH5_jL9(kM2)nB4}
      JWT_ACCESS_EXPIRATION: 900000
      JWT_REFRESH_EXPIRATION: 86400000
    ports:
      - "8081:8081"
    depends_on:
      user-db:
        condition: service_healthy
    networks:
      - citymate-network
    restart: unless-stopped

  # ============================================
  # API GATEWAY (Port 8090)
  # ============================================
  api-gateway:
    build:
      context: ../api-gateway
      dockerfile: Dockerfile
    container_name: citymate-api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET:-Cm2K9#xP7!vQ2@wR4$eT6^yU8&iO0*aS1-dF3+gH5_jL9(kM2)nB4}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8090:8090"
    depends_on:
      - user-api
      - redis
    networks:
      - citymate-network
    restart: unless-stopped

# ============================================
# VOLUMES PERSISTANTS
# ============================================
volumes:
  user-db-data:
    driver: local
  city-db-data:
    driver: local
  community-db-data:
    driver: local

# ============================================
# RÉSEAU INTERNE
# ============================================
networks:
  citymate-network:
    driver: bridge